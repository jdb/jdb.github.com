<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Logical volume manager &mdash; bits v0.5 documentation</title>
    <link rel="stylesheet" href="static/sphinxdoc.css" type="text/css" />
    <link rel="stylesheet" href="static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '',
        VERSION:     '0.5',
        COLLAPSE_MODINDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="static/jquery.js"></script>
    <script type="text/javascript" src="static/doctools.js"></script>
    <link rel="top" title="bits v0.5 documentation" href="index.html" />
    <link rel="next" title="Subversion’s cheatsheet" href="svn.html" />
    <link rel="prev" title="Secure shell techniques" href="ssh.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="svn.html" title="Subversion’s cheatsheet"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="ssh.html" title="Secure shell techniques"
             accesskey="P">previous</a> |</li>
        <li><a href="index.html">bits v0.5 documentation</a> &raquo;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
            <h3><a href="index.html">Table Of Contents</a></h3>
            <ul>
<li><a class="reference external" href="">Logical volume manager</a><ul>
<li><a class="reference external" href="#create-an-lvm-partition-bigger-than-two-physical-partitions">Create an lvm partition bigger than two physical partitions</a></li>
<li><a class="reference external" href="#safe-upgrades-through-rollback">Safe upgrades through rollback</a></li>
<li><a class="reference external" href="#tips">Tips</a><ul>
<li><a class="reference external" href="#resetting-the-filesystem-after-an-lvm-hot-resize-resize">Resetting the filesystem after an lvm hot resize resize</a></li>
<li><a class="reference external" href="#mounting-a-logical-volume-from-a-livecd">Mounting a logical volume from a livecd</a></li>
</ul>
</li>
<li><a class="reference external" href="#see-also">See also</a></li>
</ul>
</li>
</ul>

            <h4>Previous topic</h4>
            <p class="topless"><a href="ssh.html"
                                  title="previous chapter">Secure shell techniques</a></p>
            <h4>Next topic</h4>
            <p class="topless"><a href="svn.html"
                                  title="next chapter">Subversion&#8217;s cheatsheet</a></p>
            <h3>This Page</h3>
            <ul class="this-page-menu">
              <li><a href="sources/lvm.txt"
                     rel="nofollow">Show Source</a></li>
            </ul>
          <div id="searchbox" style="display: none">
            <h3>Quick search</h3>
              <form class="search" action="search.html" method="get">
                <input type="text" name="q" size="18" />
                <input type="submit" value="Go" />
                <input type="hidden" name="check_keywords" value="yes" />
                <input type="hidden" name="area" value="default" />
              </form>
              <p class="searchtip" style="font-size: 90%">
              Enter search terms or a module, class or function name.
              </p>
          </div>
          <script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="logical-volume-manager">
<h1>Logical volume manager<a class="headerlink" href="#logical-volume-manager" title="Permalink to this headline">¶</a></h1>
<div class="section" id="create-an-lvm-partition-bigger-than-two-physical-partitions">
<h2>Create an lvm partition bigger than two physical partitions<a class="headerlink" href="#create-an-lvm-partition-bigger-than-two-physical-partitions" title="Permalink to this headline">¶</a></h2>
<p>These commands can be copied and pasted with no ill effects. They will
not operate on your real hard drive partitions but on loop partitions.</p>
<ol class="arabic">
<li><p class="first">create fake partition just for demonstration purpose with losetup:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># sudo -s</span>
<span class="c"># dd if=/dev/zero of=hda1 bs=1M count=1G</span>
<span class="c"># dd if=/dev/zero of=hda2 bs=1M count=1G</span>
<span class="c"># losetup /dev/loop1 hda1        # for demonstration purpose, I create two fake</span>
<span class="c"># losetup /dev/loop2 hda2        # partitions from newly created files with losetup.</span>
</pre></div>
</div>
</li>
<li><p class="first">At this point, there are two unused partitions. We can merge them
into one:</p>
<div class="highlight-python"><pre># pvcreate /dev/loop1
  Physical volume "/dev/loop1" successfully created

# pvcreate /dev/loop2
  Physical volume "/dev/loop2" successfully created

# vgcreate datadisks /dev/loop2 /dev/loop1
  Volume group "datadisks" successfully created

# lvcreate -n muzak -L 24M datadisks
  Logical volume "muzak" created</pre>
</div>
</li>
<li><p class="first">The partition <tt class="docutils literal"><span class="pre">/dev/mapper/datadisks-muzak</span></tt> is free, let&#8217;s create a
filesystem and put some file on it:</p>
<div class="highlight-python"><pre># mkfs.ext4 /dev/mapper/datadisks-muzak

# mkdir /mnt/muzak &amp;&amp; mount /dev/mapper/datadisks-muzak /mnt/muzak

# dd if=/dev/zero of=metronomy bs=1M count=1300

# du -sh metronomy
  22M     metronomy

# cpt metronomy /mnt/muzak</pre>
</div>
<p>From two partition (20M and 10M), we created a lv of 24M in which we
copied more data (22M) than available on each of the partitions taken
separatly.</p>
</li>
<li><p class="first">cleaning up:</p>
<div class="highlight-python"><pre># umount /mnt/muzak

# lvremove datadisks/muzak
Do you really want to remove active logical volume "muzak"? [y/n]: y
  Logical volume "muzak" successfully removed

# vgremove datadisks
  Volume group "datadisks" successfully removed

# pvremove /dev/loop1 /dev/loop2
  Labels on physical volume "/dev/loop1" successfully wiped
  Labels on physical volume "/dev/loop2" successfully wiped

## lvm cleanup is done by now, let's clean the fake partitions
# losetup -d /dev/loop2
# losetup -d /dev/loop1
# rm hda{1,2} metronomy -r /mnt/muzek</pre>
</div>
</li>
</ol>
</div>
<div class="section" id="safe-upgrades-through-rollback">
<h2>Safe upgrades through rollback<a class="headerlink" href="#safe-upgrades-through-rollback" title="Permalink to this headline">¶</a></h2>
<p>The example is a website with a database which gets into production
and needs to be updated 1. without service interruption, 2. safely.
Now, if the upgrade goes bad, we want a rollback and a short service
interruption is tolerated.</p>
<ol class="arabic">
<li><p class="first">Create a fake physical partition, a lvm group and volume with a filesystem:</p>
<div class="highlight-python"><pre># cd &amp;&amp; sudo -s
# dd if=/dev/zero of=hda1 bs=1M count=150
# losetup /dev/loop1 hda1
# pvcreate /dev/loop1
  Physical volume "/dev/loop1" successfully created

# vgcreate datadisks /dev/loop1
  Volume group "datadisks" successfully created

# lvcreate -n website -L 100M datadisks
  Logical volume "website" created

# mkfs.ext4 /dev/mapper/datadisks-website

# mkdir /mnt/website &amp;&amp; mount /dev/mapper/datadisks-website /mnt/website

# touch /mnt/website/{database,index.html}</pre>
</div>
</li>
<li><p class="first">Put the system in production and make it public. Everyday, users
are created in your database:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># echo &quot;name:alice,age:29&quot; &gt;&gt; /mnt/website/database</span>
<span class="c"># echo &quot;name:bob,age:18&quot; &gt;&gt; /mnt/website/database</span>
</pre></div>
</div>
</li>
<li><p class="first">Now you want to upgrade the system, the database schema is modified
to allow an id field. That&#8217;s the database:</p>
<div class="highlight-python"><pre># cat /mnt/website/database
name:alice,age:29
name:bob,age:18</pre>
</div>
<p>It should end up look like this:</p>
<div class="highlight-python"><pre>id=001,name:alice,age:29
id=002,name:bob,age:18</pre>
</div>
<p>Architects and developper gather and we end up with an upgrade
procedure composed of an lvm snapshot:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># lvcreate -s -n website_backup -L 25M  /dev/datadisks/website</span>
</pre></div>
</div>
<p>of the working database and some database mangling commands:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># nl -n rz -w 5 /mnt/website/database | sed &#39;s/\t/,/; s/^/if:/&#39; &gt; /mnt/website/database.new</span>
<span class="c"># mv /mnt/website/database{.new,}</span>
</pre></div>
</div>
<p>The upgrade procedure require the database to go read only, no new
users can be created. Comes the night of the upgrade, at dawn, the
db looks like:</p>
<div class="highlight-python"><pre># cat /mnt/website/database
if=001,name:alice,age:29
if=002;name:bob,age:18</pre>
</div>
<p>Ouuuch man! it is corrupted, there is no &#8216;id&#8217; column in the
database, plus it is written &#8216;if&#8217; everywhere now and we have no
clue why. We need to go back to the lab, figure out what
happened... What do we do now? we need roll back so that the
production site can continue, here is the command:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># mkdir /mnt/backup</span>
<span class="c"># mount /dev/datadisks/website_backup /mnt/backup</span>
<span class="c"># cp /mnt/backup/database /mnt/website/database</span>
<span class="c"># umount /mnt/backup/database</span>
<span class="c"># lvremove /dev/datadisks/website_backup</span>
<span class="c"># cat /mnt/website/database</span>
</pre></div>
</div>
</li>
<li><p class="first">Three weeks later many many more users have been created:</p>
<div class="highlight-python"><pre># cat /mnt/website/database
name:alice,age:29
name:bob,age:18
name:robwilco,age:35
name:duncanmacleod,age:539</pre>
</div>
<p>and R&amp;D has come up with a <em>complete</em> re-design of the upgrade
procedure: a snapshot and some <em>correct</em> database mangling
commands:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># lvcreate -s -n website_backup -L 25M  /dev/datadisks/website</span>
<span class="c"># nl -n rz -w 5 /mnt/website/database | sed &#39;s/\t/,/; s/^/id:/&#39; &gt; /mnt/website/database.new</span>
<span class="c"># mv /mnt/website/database{.new,}</span>
</pre></div>
</div>
<p>At dawn, the database is correct, the snapshot safety was
thankfully not used:</p>
<div class="highlight-python"><pre># cat /mnt/website/database
id:00001,name:alice,age:29
id:00002,name:bob,age:18
id:00003,name:robwilco,age:35
id:00004,name:duncanmacleod,age:539</pre>
</div>
<p>It is possible to remove the snapshot, and even after that the
database is still up to date:</p>
<div class="highlight-python"><pre># lvremove /dev/datadisks/website_backup
# cat /mnt/website/database
id:00001,name:alice,age:29
id:00002,name:bob,age:18
id:00003,name:robwilco,age:35
id:00004,name:duncanmacleod,age:539</pre>
</div>
</li>
<li><p class="first">To clean up after this exercice:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># umount /mnt/website/</span>
<span class="c"># lvremove /dev/datadisks/website</span>
<span class="c"># vgremove datadisks</span>
<span class="c"># pvremove /dev/loop1</span>
<span class="c"># losetup -d /dev/loop1</span>
<span class="c"># rm hda1</span>
</pre></div>
</div>
</li>
</ol>
</div>
<div class="section" id="tips">
<h2>Tips<a class="headerlink" href="#tips" title="Permalink to this headline">¶</a></h2>
<div class="section" id="resetting-the-filesystem-after-an-lvm-hot-resize-resize">
<h3>Resetting the filesystem after an lvm hot resize resize<a class="headerlink" href="#resetting-the-filesystem-after-an-lvm-hot-resize-resize" title="Permalink to this headline">¶</a></h3>
<p>You may need the following so that lvs and df -h agrees on the disk sizes</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">umount</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">mapper</span><span class="o">/</span><span class="n">fnac</span><span class="o">-</span><span class="n">fnac</span>
<span class="n">e2fsck</span> <span class="o">-</span><span class="n">f</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">mapper</span><span class="o">/</span><span class="n">fnac</span><span class="o">-</span><span class="n">fnac</span>
<span class="n">resize2fs</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">mapper</span><span class="o">/</span><span class="n">fnac</span><span class="o">-</span><span class="n">fnac</span>
</pre></div>
</div>
<p>Is the umount necessary ?</p>
</div>
<div class="section" id="mounting-a-logical-volume-from-a-livecd">
<h3>Mounting a logical volume from a livecd<a class="headerlink" href="#mounting-a-logical-volume-from-a-livecd" title="Permalink to this headline">¶</a></h3>
<p>You cannot boot a live CD and expect the logical volume to be &#8220;mount
ready&#8221; as is a standard ext4. You need to type</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">vgscan</span> <span class="o">--</span><span class="n">mknodes</span>
<span class="n">vgchange</span> <span class="o">-</span><span class="n">ay</span>
</pre></div>
</div>
<p>Now you&#8217;re set</p>
<div class="highlight-python"><pre>lvscan
mount /dev/mini/root /mnt/</pre>
</div>
<p>Also, I could not <tt class="docutils literal"><span class="pre">vgscan</span></tt>, with the feisty live even after having
installed <tt class="docutils literal"><span class="pre">lvm2</span></tt> (<tt class="docutils literal"><span class="pre">Unable</span> <span class="pre">to</span> <span class="pre">mount</span> <span class="pre">drive</span> <span class="pre">('LVM2_member')</span></tt>, and
<tt class="docutils literal"><span class="pre">No</span> <span class="pre">program</span> <span class="pre">“vgscan”</span> <span class="pre">found</span> <span class="pre">for</span> <span class="pre">your</span> <span class="pre">current</span> <span class="pre">version</span> <span class="pre">of</span> <span class="pre">LVM</span></tt>). I had
to use the Knoppix liveCD v5, instead.</p>
</div>
</div>
<div class="section" id="see-also">
<h2>See also<a class="headerlink" href="#see-also" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><a class="reference external" href="http://www.debian-administration.org/articles/410">http://www.debian-administration.org/articles/410</a></li>
<li><a class="reference external" href="http://www.linuxdevcenter.com/pub/a/linux/2006/04/27/managing-disk-space-with-lvm.html">http://www.linuxdevcenter.com/pub/a/linux/2006/04/27/managing-disk-space-with-lvm.html</a></li>
<li><a class="reference external" href="http://www.howtoforge.com/linux_lvm">http://www.howtoforge.com/linux_lvm</a></li>
<li><a class="reference external" href="http://tldp.org/HOWTO/LVM-HOWTO/">http://tldp.org/HOWTO/LVM-HOWTO/</a></li>
</ul>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="svn.html" title="Subversion’s cheatsheet"
             >next</a> |</li>
        <li class="right" >
          <a href="ssh.html" title="Secure shell techniques"
             >previous</a> |</li>
        <li><a href="index.html">bits v0.5 documentation</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
      &copy; Copyright 2009, jdb.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 0.6.3.
    </div>
  </body>
</html>