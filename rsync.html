<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>rsync &mdash; bits v0.5 documentation</title>
    <link rel="stylesheet" href="static/default.css" type="text/css" />
    <link rel="stylesheet" href="static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '',
        VERSION:     '0.5',
        COLLAPSE_MODINDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="static/jquery.js"></script>
    <script type="text/javascript" src="static/doctools.js"></script>
    <link rel="top" title="bits v0.5 documentation" href="index.html" />
    <link rel="next" title="Partitioning a disk" href="partition.html" />
    <link rel="prev" title="phoronix test suite" href="phoronix.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="partition.html" title="Partitioning a disk"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="phoronix.html" title="phoronix test suite"
             accesskey="P">previous</a> |</li>
        <li><a href="index.html">bits v0.5 documentation</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="rsync">
<h1>rsync<a class="headerlink" href="#rsync" title="Permalink to this headline">¶</a></h1>
<div class="section" id="incremental-backup">
<h2>Incremental backup<a class="headerlink" href="#incremental-backup" title="Permalink to this headline">¶</a></h2>
<div class="highlight-python"><pre>#!/bin/sh
#backup.sh

# `rsync src/ dst/` snchronize src and dst so that only the difference
# between the dirs will be *transferred* between source and destination

# `rsync -a src/ dst/`  -a stand for "archive" and implies "the whole
# directory recursively" plus "keep the date and permissions"

# `--link-dest=most-recent` is the magic option that allows only the
# differences between dest and the most recent backup to occupy space
# on disk (ie incremental backup)


if [ -f /etc/backuprc   ]; then source /etc/backuprc  ; fi
if [ -f $HOME/.backuprc ]; then source $HOME/.backuprc; fi

precious=${1:-${precious_directory:-precious_directory}}
  backup=${2:-${backup_directory:-backup_directory}}

( echo $precious | grep -q '^/\|:' ) || precious=`pwd`/$precious
( echo $backup   | grep -q '^/\|:' ) ||   backup=`pwd`/$backup

prefix=${3:-manual}
( echo $3 | grep  -q -o '[^[:alnum:]]' ) \
    &amp;&amp; (echo "Prefix is not alnum. Exiting"; exit 1 )

name=$prefix-`date +%F-%H-%M-%S`
max=$((${max:-5}+1))  # max backup kept

echo $backup | grep -q ':'

if [ $?  -eq 0 ]; then
      host=`echo $backup | cut -d ':' -f 1`
    backup=`echo $backup | cut -d ':' -f 2`

    cmd="ls -d $backup/$prefix-* 2&gt;/dev/null "
    recent=`echo $cmd | ssh $host 2&gt;/dev/null  | head -n 1`

    ssh $host "cp -al $recent $backup/$name

    rsync -e ssh -a --delete $precious/ $host:$backup/$name/  \
     || ( echo -e "rsync error. Exiting.";  exit 1 )

    echo "new backup \"$backup/$name\" was created on $host."

    cmd="ls -rd $backup/$prefix-* 2&gt;/dev/null"
    oldest=` echo $cmd | ssh $host 2&gt;/dev/null | sed  -n "$max,\\$p" `
    if [ ! -z "$oldest" ] ; then
     echo $oldest | ssh $host "xargs  rm -r"
     for i in $oldest; do
         echo "old backup \"$i\" was deleted on $host."; done; fi

else

    cd $backup
    recent=`ls -d $prefix-* 2&gt;/dev/null | head -n 1`

    rsync -e ssh -a --delete --link-dest=$recent $precious/ $name/ \
     || ( echo -e "rsync error. Exiting.";  exit 1 )
    echo "new backup \"`pwd`/$name\" was created."

    oldest=`ls -rd $prefix-* | sed  -n "$max,\\$p" `
    if [ ! -z "$oldest" ] ; then
     for i in $oldest; do
         rm -r $i ;
         echo "old backup \"`pwd`/$i\" was deleted."; done; fi
fi</pre>
</div>
</div>
<div class="section" id="notes">
<h2>Notes<a class="headerlink" href="#notes" title="Permalink to this headline">¶</a></h2>
<blockquote>
<ul>
<li><p class="first">prerequisite: rsync + ssh, installed both locally and remotely</p>
</li>
<li><p class="first">make sure the filesystem is inactive when taking the backup or
rollbacking (switch off apache or backup a lvm snapshot)</p>
</li>
<li><p class="first">rollback:</p>
<div class="highlight-python"><pre>rsync -a --delete $recent/ /my-precious-directory/</pre>
</div>
</li>
<li><p class="first">cron: put the backup script in /usr/local/bin/backup.sh and in
/etc/cron.daily place this executable script:</p>
<div class="highlight-python"><pre>#!/bin/sh
/usr/local/bin/backup.sh /home/jd/toto /home/jd/tata daily</pre>
</div>
</li>
</ul>
</blockquote>
</div>
<div class="section" id="most-recent-backup">
<h2>Most recent backup<a class="headerlink" href="#most-recent-backup" title="Permalink to this headline">¶</a></h2>
<p>To minize the data kept on disk, we reuse the most recent backup, to
keep only the differences between the current data and the most recent
backup. To determine the most recent backup, it is possible to:</p>
<ul class="simple">
<li>use the modification time of the backup folder (fragile, just don&#8217;t
&#8220;touch&#8221; the oldest backup!)</li>
<li>use the name of the backup and it contains the date (we use this
solution)</li>
</ul>
</div>
<div class="section" id="tests">
<h2>Tests<a class="headerlink" href="#tests" title="Permalink to this headline">¶</a></h2>
<blockquote>
<ul>
<li><p class="first">bogus options: none,  non alnum characters for the prefix</p>
<div class="highlight-python"><pre>backup.sh
backup.sh azert
backup.sh a b 2,2
backup.sh a apu:b</pre>
</div>
</li>
<li><p class="first">remote, distant ??</p>
</li>
<li><p class="first">No recent, rsync does the right thing. Non existing directory:
rsync stops, we care for the return code.</p>
</li>
</ul>
</blockquote>
</div>
<div class="section" id="bugs">
<h2>Bugs<a class="headerlink" href="#bugs" title="Permalink to this headline">¶</a></h2>
<blockquote>
<ul>
<li><p class="first">Incremental disk write does not work remotely ie when the value of
the option &#8211;link-dest includes a host</p>
<div class="highlight-python"><pre>rsync precious/ apu:/var/backups/
rsync --link-dest=/var/backups/recent precious/ /var/backups/new-backup
rsync --link-dest=apu:/var/backups/recent precious/ apu:/var/backups/new-backup</pre>
</div>
</li>
<li><p class="first">now I prefer names like {{{backup-1}}} to {{{backup-<cite>date +%F</cite>}}}</p>
</li>
</ul>
</blockquote>
</div>
<div class="section" id="integration-of-virtual-machines">
<h2>Integration of virtual machines<a class="headerlink" href="#integration-of-virtual-machines" title="Permalink to this headline">¶</a></h2>
<p>On apu, if you keep the vm name and the logical volume the same, then
you can get the list of lv to backup by looking for the vm config
files in /etc/xen (grepping some vm config file pattern). Then,
iterating on this list :</p>
<blockquote>
<ul class="simple">
<li>mount a snapshot of the lv in /mnt/snap</li>
<li>make a backup from /mnt/snap to /var/backup/$i</li>
<li>umount snapshot</li>
</ul>
</blockquote>
<p>The script can be launched daily, weekly and monthly by putting it
into /usr/local and putting a link to it in cron.*. Also, I want to be
able launch it by hand on a specific vm just by specifying the vm and
it would happily backup the vm to manual/</p>
<div class="highlight-python"><pre>#!/bin/bash
max=10

if [ -z "$PS1" ];
then  # non interactif

    # prefix should be either daily, weekly,.. since launch from cron.{daily,weekly,...}
    prefix=$(basename `pwd`  | cut -f 2 -d '.')
    vmlist=`ls /etc/xen | xargs grep -H vif  | cut -f 1 -d ':'`  # get the list of vm form /etc/xen/*

else  # mode interactif

    if [ ! -f /etc/xen/$1 ] ; then
        echo $i is not a xen domU;
        exit 1 ; done

    if [ $? -ne `lvs | awk '{print $1}' | grep -q $1` ]; then
        echo $i logical volume;
        exit 1 ; done

    if [ ! -d /var/backup/$i ] ; then
        mkdir -p -d /var/backup/$i; done

    prefix=manual
    vmlist=
fi

clean-up () {
    umount /mnt/snap &amp;&amp; lvremove sys/snap
    exit 1
}

trap clean-up SIGINT SIGTERM

for i in $vmlist; do
    lvcreate -s -n snap -L 200m  sys/$i
    mount /dev/sys/snap /mnt/snap

    (   cd $backup/$i
        recent=`ls manual-* | head -n 1`

        rsync -a --delete --link-dest=$recent /mnt/snap/ $prefix-`date +%F`

        # delete the oldest backup if there are at least 10 backups
        oldest=`ls  $prefix-* | sed  -n "$max,\$p" | tail -n 1`
        if [ -d "$oldest" ] ; then rm -r $oldest ; fi
    )

    umount /mnt/snap &amp;&amp; lvremove sys/snap

done</pre>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
            <h3><a href="index.html">Table Of Contents</a></h3>
            <ul>
<li><a class="reference external" href="">rsync</a><ul>
<li><a class="reference external" href="#incremental-backup">Incremental backup</a></li>
<li><a class="reference external" href="#notes">Notes</a></li>
<li><a class="reference external" href="#most-recent-backup">Most recent backup</a></li>
<li><a class="reference external" href="#tests">Tests</a></li>
<li><a class="reference external" href="#bugs">Bugs</a></li>
<li><a class="reference external" href="#integration-of-virtual-machines">Integration of virtual machines</a></li>
</ul>
</li>
</ul>

            <h4>Previous topic</h4>
            <p class="topless"><a href="phoronix.html"
                                  title="previous chapter">phoronix test suite</a></p>
            <h4>Next topic</h4>
            <p class="topless"><a href="partition.html"
                                  title="next chapter">Partitioning a disk</a></p>
            <h3>This Page</h3>
            <ul class="this-page-menu">
              <li><a href="sources/rsync.txt"
                     rel="nofollow">Show Source</a></li>
            </ul>
          <div id="searchbox" style="display: none">
            <h3>Quick search</h3>
              <form class="search" action="search.html" method="get">
                <input type="text" name="q" size="18" />
                <input type="submit" value="Go" />
                <input type="hidden" name="check_keywords" value="yes" />
                <input type="hidden" name="area" value="default" />
              </form>
              <p class="searchtip" style="font-size: 90%">
              Enter search terms or a module, class or function name.
              </p>
          </div>
          <script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="partition.html" title="Partitioning a disk"
             >next</a> |</li>
        <li class="right" >
          <a href="phoronix.html" title="phoronix test suite"
             >previous</a> |</li>
        <li><a href="index.html">bits v0.5 documentation</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
      &copy; Copyright 2009, jdb.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 0.6.2.
    </div>
  </body>
</html>